<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>启动加载器（Bootloader） :: Embassy中文文档</title>
    <link rel="canonical" href="https://embassy.dev/book/zh/bootloader.html">
    <meta name="generator" content="Antora 3.1.12">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
    <link rel="icon" href="../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <h1>Embassy Documentation</h1>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/embassy-rs/embassy" target="_blank">GitHub</a>
        <a class="navbar-item" href="https://matrix.to/#/#embassy-rs:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://embassy.dev">Documentation</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="ROOT" data-version="zh">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Embassy中文文档</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="getting_started.html">快速开始</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic_application.html">基础应用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="project_structure.html">项目结构</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="new_project.html">新建一个Embassy工程</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="best_practices.html">最佳实践</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="runtime.html">执行器（Executor）</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="time_keeping.html">计时（Time-keeping）</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="sharing_peripherals.html">共享外设</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="hal.html">硬件抽象层（HAL）</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="layer_by_layer.html">解剖Async HAL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="nrf.html">nRF</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stm32.html">STM32</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="bootloader.html">引导程序（Bootloader）</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="examples.html">示例</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="developer.html">开发文档</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="developer_stm32.html">开发文档：STM32</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="embassy_in_the_wild.html">Embassy in the wild</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="faq.html">常见问题</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Embassy中文文档</span>
    <span class="version">中文</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Embassy中文文档</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">中文</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Embassy中文文档</a></li>
    <li><a href="bootloader.html">引导程序（Bootloader）</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/decaday/embassy-docs-zh/edit/main/docs/zh/modules/ROOT/pages/bootloader.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">启动加载器（Bootloader）</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><code>embassy-boot</code> 是一个轻量级启动加载器，支持断电安全的固件应用升级，具备试运行和回滚功能。</p>
</div>
<div class="paragraph">
<p>该启动加载器既可以作为库使用，也可以直接烧录（如果你对默认配置和功能满意）。</p>
</div>
<div class="paragraph">
<p>设计上，启动加载器不提供任何网络功能。获取新固件的网络能力应由用户应用实现，可以将启动加载器作为库来更新固件，或在库的基础上自行添加网络功能。</p>
</div>
<div class="paragraph">
<p>该启动加载器通过依赖 <code>embedded-storage</code> traits 支持内部和外部 flash。还可选支持对已数字签名固件的验证（推荐开启）。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_硬件支持"><a class="anchor" href="#_硬件支持"></a>硬件支持</h2>
<div class="sectionbody">
<div class="paragraph">
<p>启动加载器支持：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>nRF52（支持/不支持 softdevice）</p>
</li>
<li>
<p>STM32 L4、WB、WL、L1、L0、F3、F7 和 H7</p>
</li>
<li>
<p>树莓派 RP2040</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>一般来说，只要平台为其内部 flash 实现了 <code>embedded-storage</code> traits，启动加载器都能工作，但可能需要自定义初始化代码。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_设计"><a class="anchor" href="#_设计"></a>设计</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="_images/bootloader_flash.png" alt="Bootloader flash layout">
</div>
</div>
<div class="paragraph">
<p>启动加载器将存储空间分为 4 个主要分区，可在创建实例或通过链接脚本配置：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BOOTLOADER —— 启动加载器本身存放位置。大约占用 8kB flash，如果需要调试且空间充足，建议增大到 24kB 以便用 probe-rs 调试。</p>
</li>
<li>
<p>ACTIVE —— 主应用存放位置。启动加载器会尝试从该分区起始处加载应用。该分区仅由启动加载器写入，所需大小取决于应用体积。</p>
</li>
<li>
<p>DFU —— 待切换的新应用存放位置。该分区由应用写入，必须比 ACTIVE 分区至少大 1 页，因为交换算法需要额外空间保证断电安全：</p>
<div class="paragraph">
<p>分区大小<sub>dfu</sub> = 分区大小<sub>active</sub> + 页大小<sub>active</sub></p>
</div>
<div class="paragraph">
<p>所有值均为字节。</p>
</div>
</li>
<li>
<p>BOOTLOADER STATE —— 启动加载器存储当前状态（如是否需要交换 active 和 dfu 分区）。当新固件写入 DFU 分区后，会写入一个 magic 字段，指示启动加载器进行分区交换。该分区需能存储 magic 字段和交换进度，大小为：</p>
<div class="paragraph">
<p>分区大小<sub>state</sub> = 写入大小<sub>state</sub> + (2 × 分区大小<sub>active</sub> / 页大小<sub>active</sub>)</p>
</div>
<div class="paragraph">
<p>所有值均为字节。</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>ACTIVE（+BOOTLOADER）、DFU 和 BOOTLOADER_STATE 分区可放在不同 flash。启动加载器使用的页大小为 ACTIVE 和 DFU 页大小的最小公倍数。
BOOTLOADER_STATE 分区需足够大，能为 ACTIVE 和 DFU 分区的每一页存储一个字。</p>
</div>
<div class="paragraph">
<p>启动加载器有平台无关部分，实现断电安全交换算法；平台相关部分为最小 shim，提供看门狗等功能或支持 nRF52 softdevice。</p>
</div>
<div class="paragraph">
<p>注意：应用和启动加载器的链接脚本类似，但 FLASH 区域需分别指向 BOOTLOADER（启动加载器）和 ACTIVE（应用）分区。</p>
</div>
<div class="sect2">
<h3 id="_firmwareupdater"><a class="anchor" href="#_firmwareupdater"></a>FirmwareUpdater</h3>
<div class="paragraph">
<p><code>FirmwareUpdater</code> 对象用于方便地将固件写入 DFU 分区，并在下次重启时标记为可与 active 分区交换。主要方法有 <code>write_firmware</code>（每个 flash 写块调用一次，通常为 4KiB）和 <code>mark_updated</code>（最后调用）。</p>
</div>
</div>
<div class="sect2">
<h3 id="_验证"><a class="anchor" href="#_验证"></a>验证</h3>
<div class="paragraph">
<p>启动加载器支持对 DFU 分区已写入固件的验证。验证要求固件使用 <a href="https://ed25519.cr.yp.to/"><code>ed25519</code></a> 数字签名。启用验证后，需用 <code>FirmwareUpdater::verify_and_mark_updated</code> 替代 <code>mark_updated</code>，并提供公钥、签名和固件实际长度。验证失败则不会标记为已更新，固件会被拒绝。</p>
</div>
<div class="paragraph">
<p>签名通常随固件一起传递，不写入 flash。如何传递签名由固件自行决定。</p>
</div>
<div class="paragraph">
<p>如需启用验证，依赖 <code>embassy-boot</code> crate 时启用 <code>ed25519-dalek</code> 或 <code>ed25519-salty</code> 特性。推荐使用 <code>ed25519-salty</code>，因其体积更小。</p>
</div>
<div class="sect3">
<h4 id="_关于_ed25519_密钥与签名的提示"><a class="anchor" href="#_关于_ed25519_密钥与签名的提示"></a>关于 Ed25519 密钥与签名的提示</h4>
<div class="paragraph">
<p>Ed25519 是一种公钥签名系统，需妥善保管私钥。建议将*公钥*嵌入程序，便于传递给 <code>verify_and_mark_updated</code>。例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">static PUBLIC_SIGNING_KEY: &amp;[u8] = include_bytes!("key.pub");</code></pre>
</div>
</div>
<div class="paragraph">
<p>签名通常与固件一起传递，可直接追加。</p>
</div>
<div class="paragraph">
<p>Ed25519 密钥可用多种工具生成。推荐 <a href="https://man.openbsd.org/signify"><code>signify</code></a>，广泛用于 OpenBSD 发行版签名与验证，且易用。</p>
</div>
<div class="paragraph">
<p>以下 Bash 命令可在 Unix 平台生成公私钥，并生成无头部的 <code>key.pub</code> 文件。请将 <code>SECRETS_DIR</code> 环境变量设为安全目录。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">signify -G -n -p $SECRETS_DIR/key.pub -s $SECRETS_DIR/key.sec
tail -n1 $SECRETS_DIR/key.pub | base64 -d -i - | dd ibs=10 skip=1 &gt; key.pub
chmod 700 $SECRETS_DIR/key.sec
export SECRET_SIGNING_KEY=$(tail -n1 $SECRETS_DIR/key.sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>签名固件时，假设已声明 <code>FIRMWARE_DIR</code>，固件文件名为 <code>myfirmware</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">shasum -a 512 -b $FIRMWARE_DIR/myfirmware &gt; $SECRETS_DIR/message.txt
cat $SECRETS_DIR/message.txt | dd ibs=128 count=1 | xxd -p -r &gt; $SECRETS_DIR/message.txt
signify -S -s $SECRETS_DIR/key.sec -m $SECRETS_DIR/message.txt -x $SECRETS_DIR/message.txt.sig
cp $FIRMWARE_DIR/myfirmware $FIRMWARE_DIR/myfirmware+signed
tail -n1 $SECRETS_DIR/message.txt.sig | base64 -d -i - | dd ibs=10 skip=1 &gt;&gt; $FIRMWARE_DIR/myfirmware+signed</code></pre>
</div>
</div>
<div class="paragraph">
<p>请务必妥善保管 <code>$SECRETS_DIR/key.sec</code>，一旦泄露，其他人即可签名你的固件。</p>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a modified version of the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
