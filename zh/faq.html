<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>常见问题解答 :: Embassy中文文档</title>
    <link rel="canonical" href="https://embassy.dev/book/zh/faq.html">
    <meta name="generator" content="Antora 3.1.12">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
    <link rel="icon" href="../_/img/favicon.svg" type="image/svg+xml">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <h1>Embassy Documentation</h1>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/embassy-rs/embassy" target="_blank">GitHub</a>
        <a class="navbar-item" href="https://matrix.to/#/#embassy-rs:matrix.org" target="_blank">Chat</a>
        <a class="navbar-item" href="https://embassy.dev">Documentation</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="ROOT" data-version="zh">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Embassy中文文档</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="getting_started.html">快速开始</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="basic_application.html">基础应用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="project_structure.html">项目结构</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="new_project.html">新建一个Embassy工程</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="best_practices.html">最佳实践</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="runtime.html">执行器（Executor）</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="time_keeping.html">计时（Time-keeping）</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="sharing_peripherals.html">共享外设</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="hal.html">硬件抽象层（HAL）</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="layer_by_layer.html">解剖Async HAL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="nrf.html">nRF</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stm32.html">STM32</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bootloader.html">引导程序（Bootloader）</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="examples.html">示例</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="developer.html">开发文档</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="developer_stm32.html">开发文档：STM32</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="embassy_in_the_wild.html">Embassy in the wild</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="faq.html">常见问题</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Embassy中文文档</span>
    <span class="version">中文</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="index.html">Embassy中文文档</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">中文</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Embassy中文文档</a></li>
    <li><a href="faq.html">常见问题</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/decaday/embassy-docs-zh/edit/main/docs/zh/modules/ROOT/pages/faq.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">常见问题解答</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>这里是一些未排序的常见问题及解答。</p>
</div>
<div class="paragraph">
<p>如果你在聊天中得到了问题的答案，欢迎随时在 <a href="https://github.com/embassy-rs/embassy/edit/main/docs/modules/ROOT/pages/faq.adoc">此页面</a> 添加内容！</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_如何在没有_debugging_probe_的情况下部署到_rp2040"><a class="anchor" href="#_如何在没有_debugging_probe_的情况下部署到_rp2040"></a>如何在没有 debugging probe 的情况下部署到 RP2040</h2>
<div class="sectionbody">
<div class="paragraph">
<p>安装 <a href="https://github.com/JoNil/elf2uf2-rs">elf2uf2-rs</a>，用于将生成的 elf 二进制文件转换为 uf2 文件。</p>
</div>
<div class="paragraph">
<p>配置 runner 使用该工具，在 <code>.cargo/config.toml</code> 中添加如下内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[target.'cfg(all(target_arch = "arm", target_os = "none"))']
runner = "elf2uf2-rs --deploy --serial --verbose"</code></pre>
</div>
</div>
<div class="paragraph">
<p>命令行参数 <code>--deploy</code> 会自动检测你的设备并上传二进制文件，<code>--serial</code> 会启动串口连接。更多信息请查阅文档。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_缺少_main_宏"><a class="anchor" href="#_缺少_main_宏"></a>缺少 main 宏</h2>
<div class="sectionbody">
<div class="paragraph">
<p>如果你看到如下错误：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">#[embassy_executor::main]
|                   ^^^^ could not find `main` in `embassy_executor`</code></pre>
</div>
</div>
<div class="paragraph">
<p>你很可能缺少了 <code>embassy-executor</code> crate 的某些特性。</p>
</div>
<div class="paragraph">
<p>对于 Cortex-M 目标，请确保在 <code>Cargo.toml</code> 的 <code>embassy-executor</code> crate 中启用了以下所有特性：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>arch-cortex-m</code></p>
</li>
<li>
<p><code>executor-thread</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>对于 ESP32，请考虑使用对应 <a href="https://crates.io/crates/esp-hal-common">HAL crate</a> 提供的 executors 和 <code>#[main]</code> 宏。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_为什么我的二进制文件这么大"><a class="anchor" href="#_为什么我的二进制文件这么大"></a>为什么我的二进制文件这么大？</h2>
<div class="sectionbody">
<div class="paragraph">
<p>管理二进制体积的第一步是设置 <a href="https://doc.rust-lang.org/cargo/reference/profiles.html">profiles</a>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[profile.release]
lto = true
opt-level = "s"
incremental = false
codegen-units = 1
# 注意：设置 debug = true 没问题，调试信息不会被烧录到设备！
debug = true</code></pre>
</div>
</div>
<div class="paragraph">
<p>这些参数的详细说明见上面链接的 Rust Book 页面。</p>
</div>
<div class="sect2">
<h3 id="_我的二进制依然很大充满了_stdfmt_相关内容"><a class="anchor" href="#_我的二进制依然很大充满了_stdfmt_相关内容"></a>我的二进制依然很大，充满了 <code>std::fmt</code> 相关内容！</h3>
<div class="paragraph">
<p>这说明你的代码足够复杂，<code>panic!</code> 的格式化需求没有被优化掉，即使你用了 <code>panic-halt</code> 或 <code>panic-reset</code>。</p>
</div>
<div class="paragraph">
<p>你可以在 <code>.cargo/config.toml</code> 中添加如下内容来解决：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[unstable]
build-std = ["core"]
build-std-features = ["panic_immediate_abort"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>这会将所有 panic 替换为 <code>UDF</code>（未定义）指令。</p>
</div>
<div class="paragraph">
<p>具体行为取决于芯片型号。</p>
</div>
<div class="paragraph">
<p>请查阅芯片手册，对于 <code>thumbv6m</code>，这会导致 hardfault。可以这样配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">#[exception]
unsafe fn HardFault(_frame: &amp;ExceptionFrame) -&gt; ! {
    SCB::sys_reset() // 你也可以做其他操作
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>更多信息请查阅 cortex-m 的 <a href="https://docs.rs/cortex-m-rt/latest/cortex_m_rt/attr.exception.html">异常处理</a>。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_embassy_time_报链接错误"><a class="anchor" href="#_embassy_time_报链接错误"></a><code>embassy-time</code> 报链接错误</h2>
<div class="sectionbody">
<div class="paragraph">
<p>如果你看到如下链接错误：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">  = note: rust-lld: error: undefined symbol: _embassy_time_now
          &gt;&gt;&gt; referenced by driver.rs:127 (src/driver.rs:127)
          &gt;&gt;&gt;               embassy_time-846f66f1620ad42c.embassy_time.4f6a638abb75dd4c-cgu.0.rcgu.o:(embassy_time::driver::now::hefb1f99d6e069842) in archive Devel/Embedded/pogodyna/target/thumbv7em-none-eabihf/debug/deps/libembassy_time-846f66f1620ad42c.rlib

          rust-lld: error: undefined symbol: _embassy_time_allocate_alarm
          &gt;&gt;&gt; referenced by driver.rs:134 (src/driver.rs:134)
          &gt;&gt;&gt;               embassy_time-846f66f1620ad42c.embassy_time.4f6a638abb75dd4c-cgu.0.rcgu.o:(embassy_time::driver::allocate_alarm::hf5145b6bd46706b2) in archive Devel/Embedded/pogodyna/target/thumbv7em-none-eabihf/debug/deps/libembassy_time-846f66f1620ad42c.rlib

          rust-lld: error: undefined symbol: _embassy_time_set_alarm_callback
          &gt;&gt;&gt; referenced by driver.rs:139 (src/driver.rs:139)
          &gt;&gt;&gt;               embassy_time-846f66f1620ad42c.embassy_time.4f6a638abb75dd4c-cgu.0.rcgu.o:(embassy_time::driver::set_alarm_callback::h24f92388d96eafd2) in archive Devel/Embedded/pogodyna/target/thumbv7em-none-eabihf/debug/deps/libembassy_time-846f66f1620ad42c.rlib

          rust-lld: error: undefined symbol: _embassy_time_set_alarm
          &gt;&gt;&gt; referenced by driver.rs:144 (src/driver.rs:144)
          &gt;&gt;&gt;               embassy_time-846f66f1620ad42c.embassy_time.4f6a638abb75dd4c-cgu.0.rcgu.o:(embassy_time::driver::set_alarm::h530a5b1f444a6d5b) in archive Devel/Embedded/pogodyna/target/thumbv7em-none-eabihf/debug/deps/libembassy_time-846f66f1620ad42c.rlib</code></pre>
</div>
</div>
<div class="paragraph">
<p>你可能需要为 HAL 启用时间驱动（不是在 <code>embassy-time</code> 里！）。比如 <code>embassy-stm32</code>，你需要启用 <code>time-driver-any</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[dependencies.embassy-stm32]
version = "0.1.0"
features = [
    # ...
    "time-driver-any", # 添加这一行！
    # ...
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果你在项目早期阶段还没用到 HAL 的任何内容，请确保 HAL 被显式使用，防止链接器将其当作无用代码移除，在源码中加上：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-rust hljs" data-lang="rust">use embassy_stm32 as _;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_错误only_one_package_in_the_dependency_graph_may_specify_the_same_links_value"><a class="anchor" href="#_错误only_one_package_in_the_dependency_graph_may_specify_the_same_links_value"></a>错误：<code>Only one package in the dependency graph may specify the same links value.</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>你的依赖树中有多个版本的同一个 crate。这意味着有些 embassy crate 来自 crates.io，有些来自 git，导致依赖不一致。</p>
</div>
<div class="paragraph">
<p>解决方法：确保所有 embassy crate 都来自同一个源！
你可以用 <code>[patch.crates.io]</code> 和（如有需要）<code>[patch.'https://github.com/embassy-rs/embassy.git']</code> 来统一依赖。</p>
</div>
<div class="paragraph">
<p>示例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-toml hljs" data-lang="toml">[patch.crates-io]
embassy-time-queue-driver = { git = "https://github.com/embassy-rs/embassy.git", rev = "e5fdd35" }
embassy-time-driver = { git = "https://github.com/embassy-rs/embassy.git", rev = "e5fdd35" }
# embassy-time = { git = "https://github.com/embassy-rs/embassy.git", rev = "e5fdd35" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>注意 git 版本号要和你用的其他 embassy 依赖一致！</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_如何优化我的_embassy_stm32_程序的速度"><a class="anchor" href="#_如何优化我的_embassy_stm32_程序的速度"></a>如何优化我的 embassy-stm32 程序的速度？</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>确保 RCC 设置为最高速</p>
</li>
<li>
<p>确保启用了 <a href="https://docs.rs/cortex-m/latest/cortex_m/peripheral/struct.SCB.html">flash cache</a></p>
</li>
<li>
<p>用 <code>--release</code> 构建</p>
</li>
<li>
<p>在 <code>Cargo.toml</code> 的 release 配置中设置：</p>
<div class="ulist">
<ul>
<li>
<p><code>opt-level = "s"</code></p>
</li>
<li>
<p><code>lto = "fat"</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>在 <code>.cargo/config.toml</code> 的 <code>[unstable]</code> 部分设置：</p>
<div class="ulist">
<ul>
<li>
<p><code>build-std = ["core"]</code></p>
</li>
<li>
<p><code>build-std-features = ["panic_immediate_abort"]</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>启用特性 <code>embassy-time/generic-queue</code>，禁用 <code>embassy-executor/integrated-timers</code></p>
</li>
<li>
<p>使用 <code>InterruptExecutor</code> 时：</p>
<div class="ulist">
<ul>
<li>
<p>禁用 <code>executor-thread</code></p>
</li>
<li>
<p>让 <code>main</code> 启动所有任务，然后启用 <a href="https://docs.rs/cortex-m/latest/cortex_m/peripheral/struct.SCB.html#method.set_sleeponexit">SCB.SLEEPONEXIT</a> 并 <code>loop { cortex_m::asm::wfi() }</code></p>
</li>
<li>
<p><strong>注意</strong>：如果需要 2 个优先级，建议用 2 个中断执行器，而不是 1 个线程执行器 + 1 个中断执行器。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_如何在_stable_上配置任务_arena"><a class="anchor" href="#_如何在_stable_上配置任务_arena"></a>如何在 stable 上配置任务 arena？</h2>
<div class="sectionbody">
<div class="paragraph">
<p>未启用 <code>embassy-executor</code> 的 <code>nightly</code> 特性时，执行器使用 bump allocator，可能需要配置。</p>
</div>
<div class="paragraph">
<p>如果任务 arena <strong>太大</strong>，<strong>编译时</strong>会报错：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plain hljs" data-lang="plain">rust-lld: error: section '.bss' will not fit in region 'RAM': overflowed by _ bytes
rust-lld: error: section '.uninit' will not fit in region 'RAM': overflowed by _ bytes</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果任务 arena <strong>太小</strong>，<strong>运行时</strong>会报错：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-plain hljs" data-lang="plain">ERROR panicked at 'embassy-executor: task arena is full. You must increase the arena size, see the documentation for details: https://docs.embassy.dev/embassy-executor/'</code></pre>
</div>
</div>
<div class="paragraph">
<p>注意：如果所有任务都在启动时被 spawn，这个 panic 会立刻发生。</p>
</div>
<div class="paragraph">
<p>更多细节见 <a href="https://docs.embassy.dev/embassy-executor/git/cortex-m/index.html#task-arena">任务 Arena 文档</a>。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_可以和_embassy_一起用手写_isr_吗"><a class="anchor" href="#_可以和_embassy_一起用手写_isr_吗"></a>可以和 Embassy 一起用手写 ISR 吗？</h2>
<div class="sectionbody">
<div class="paragraph">
<p>可以！如果你需要尽可能快地响应事件，而常规的“ISR、唤醒、从 ISR 返回、上下文切换到被唤醒任务”流程延迟太大，可以像 <a href="https://docs.rust-embedded.org/book/start/interrupts.html">其他嵌入式 Rust 项目</a> 一样，直接定义 <code>#[interrupt] fn INTERRUPT_NAME() {}</code> 处理函数。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_如何测量资源使用cpuram_等"><a class="anchor" href="#_如何测量资源使用cpuram_等"></a>如何测量资源使用（CPU、RAM 等）？</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_cpu_使用率"><a class="anchor" href="#_cpu_使用率"></a>CPU 使用率</h3>
<div class="paragraph">
<p>有几种方法，通常是测量在 idle 或低优先级循环中花费的时间。</p>
</div>
<div class="paragraph">
<p>我们还需要补充 Embassy 的具体做法，<a href="https://blog.japaric.io/cpu-monitor/">这篇旧文</a> 介绍了通用流程。</p>
</div>
<div class="paragraph">
<p>如果你有实践经验，欢迎补充具体示例！</p>
</div>
</div>
<div class="sect2">
<h3 id="_静态内存使用"><a class="anchor" href="#_静态内存使用"></a>静态内存使用</h3>
<div class="paragraph">
<p><code>cargo size</code> 和 <code>cargo nm</code> 等工具可以查看全局或静态变量的大小。重点关注 <code>.data</code> 和 <code>.bss</code> 段，这两者加起来就是全局/静态内存用量。</p>
</div>
</div>
<div class="sect2">
<h3 id="_最大栈使用"><a class="anchor" href="#_最大栈使用"></a>最大栈使用</h3>
<div class="paragraph">
<p>可用 <a href="https://github.com/Dirbaio/cargo-call-stack/"><code>cargo-call-stack</code></a> 静态分析最坏情况栈用量。该工具有一些已知限制，详情见 <a href="https://github.com/dirbaio/cargo-call-stack#known-limitations">README</a>。</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using a modified version of the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
